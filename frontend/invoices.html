<!DOCTYPE html>
<html lang="vi"><head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Quản lý thanh toán - Hệ thống quản lý nhà trọ</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&amp;display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" rel="stylesheet"/>
<script src="https://cdn.tailwindcss.com?plugins=forms,typography"></script>
<script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        primary: "#009688",
                        "background-light": "#f3f4f6",
                        "background-dark": "#111827",
                        "sidebar-bg": "#1e3a8a",
                        "sidebar-bg-dark": "#0f172a",
                    },
                    fontFamily: {
                        display: ["Inter", "sans-serif"],
                    },
                    borderRadius: {
                        DEFAULT: "0.5rem",
                        'xl': "0.75rem",
                        '2xl': "1rem",
                        '3xl': "1.5rem",
                    },
                },
            },
        };
    </script>
<link rel="stylesheet" href="css/trangchu.css"/>
<link rel="stylesheet" href="css/invoice.css">
</head>
<body>
<div class="main-container">
<aside class="sidebar">
<div class="sidebar-header">
<div class="logo-icon">
<span class="material-icons-outlined">home</span>
</div>
<div class="logo-text">
<h1>TroViet</h1>
<p>Công Chủ nhà</p>
</div>
</div>
<div class="user-section">
<div class="user-avatar">
<span class="material-icons-outlined">person</span>
</div>
<div class="user-info">
<p>Admin</p>
<p>admin@troviet.com</p>
</div>
<button class="notif-btn">
<span class="material-icons-outlined">notifications</span>
</button>
</div>
<nav class="nav-menu">
<a class="nav-link" href="trangchu.html">
<span class="material-icons-outlined nav-icon">bar_chart</span>
<span>Tổng quan</span>
</a>
<a class="nav-link" href="property.html">
<span class="material-icons-outlined nav-icon">apartment</span>
<span>Bất động sản</span>
</a>
<a class="nav-link" href="contract.html">
<span class="material-icons-outlined nav-icon">people_outline</span>
<span>Người thuê</span>
</a>
<a class="nav-link active" href="invoices.html">
<span class="material-icons-outlined nav-icon">attach_money</span>
<span>Hóa đơn</span>
</a>
<a class="nav-link" href="maintenance.html">
<span class="material-icons-outlined nav-icon">build</span>
<span>Bảo trì</span>
</a>
</nav>
<div class="sidebar-footer">
<a class="nav-link" href="#">
<span class="material-icons-outlined nav-icon">settings</span>
<span>Cài đặt</span>
</a>
<a class="nav-link" href="#">
<span class="material-icons-outlined nav-icon">logout</span>
<span>Đăng xuất</span>
</a>
</div>
</aside>
<main class="main-content bg-background-light dark:bg-background-dark p-6 md:p-10 transition-colors duration-200">
            <div class="content-scroll">
                <div class="page-container">
                    
                    <div class="flex justify-between items-center" style="flex-wrap: wrap; gap: 1rem;">
                        <div>
                            <h1 class="font-bold" style="font-size: 1.875rem;">Tổng quan hóa đơn</h1>
                            <p style="color: var(--text-gray); font-size: 0.875rem; margin-top: 4px;">Theo dõi dòng tiền và trạng thái thanh toán theo thời gian thực</p>
                        </div>
                        <div>
                            <button onclick="toggleModal(true)" class="btn btn-primary">
                                <span class="material-symbols-outlined" style="font-size: 18px;">add</span>
                                <span>Tạo hóa đơn mới</span>
                            </button>
                        </div>
                    </div>
    
                    <div class="stat-grid">
                        <div class="card card-flex">
                            <div>
                                <p class="text-gray-500 font-medium" style="font-size: 0.875rem; margin-bottom: 4px;">Tổng thu nhập tháng này</p>
                                <h3 class="font-bold" style="font-size: 1.5rem;" id="stat-revenue">0 đ</h3>
                                <div class="flex items-center gap-2" style="margin-top: 1rem; font-size: 0.75rem; color: var(--success); font-weight: 500;">
                                    <span class="material-symbols-outlined" style="font-size: 16px;">trending_up</span> Thực thu (Đã thanh toán)
                                </div>
                            </div>
                            <div class="stat-icon-box bg-green-50">
                                <span class="material-symbols-outlined">attach_money</span>
                            </div>
                        </div>
                        <div class="card card-flex">
                            <div>
                                <p class="text-gray-500 font-medium" style="font-size: 0.875rem; margin-bottom: 4px;">Chờ thanh toán</p>
                                <h3 class="font-bold" style="font-size: 1.5rem;" id="stat-pending">0 đ</h3>
                                <div class="flex items-center gap-2" style="margin-top: 1rem; font-size: 0.75rem; color: var(--text-gray); font-weight: 500;">
                                    Chưa quá hạn
                                </div>
                            </div>
                            <div class="stat-icon-box bg-yellow-50">
                                <span class="material-symbols-outlined">hourglass_top</span>
                            </div>
                        </div>
                        <div class="card card-flex">
                            <div>
                                <p class="text-gray-500 font-medium" style="font-size: 0.875rem; margin-bottom: 4px;">Hóa đơn quá hạn</p>
                                <h3 class="font-bold" style="font-size: 1.5rem;" id="stat-overdue">0</h3>
                                <div class="flex items-center gap-2" style="margin-top: 1rem; font-size: 0.75rem; color: var(--danger); font-weight: 500; cursor: pointer;">
                                    Cần xử lý ngay
                                </div>
                            </div>
                            <div class="stat-icon-box bg-red-50">
                                <span class="material-symbols-outlined">warning</span>
                            </div>
                        </div>
                    </div>
    
                    <div class="filter-bar">
                        <div class="search-wrapper">
                            <span class="material-symbols-outlined search-icon">search</span>
                            <input type="text" id="searchInput" class="search-input" placeholder="Tìm tên khách hoặc số phòng..." onkeyup="loadInvoices()">
                        </div>
                        <div class="flex gap-3">
                            <input type="month" id="monthFilter" class="select-input" style="width: auto;" onchange="loadInvoices()">
                            
                            <select id="statusFilter" class="select-input" onchange="loadInvoices()">
                                <option value="all">Tất cả trạng thái</option>
                                <option value="paid">Đã thanh toán</option>
                                <option value="pending">Chưa thanh toán</option>
                                <option value="overdue">Quá hạn</option>
                            </select>
                        </div>
                    </div>
    
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Phòng</th>
                                    <th>Người thuê</th>
                                    <th>Loại</th>
                                    <th>Số tiền</th>
                                    <th>Ngày tạo</th>
                                    <th>Hạn đóng</th>
                                    <th>Trạng thái</th>
                                    <th class="text-right">Hành động</th>
                                </tr>
                            </thead>
                            <tbody id="invoiceTableBody">
                                <tr><td colspan="8" class="text-center" style="padding: 20px;">Đang tải dữ liệu...</td></tr>
                            </tbody>
                        </table>
                    </div>
    
                    <div style="height: 40px;"></div>
                </div>
            </div>
        </main>
</div>
    
    <div id="invoiceModal" class="modal" role="dialog" aria-modal="true">
        <div class="modal-backdrop" onclick="toggleModal(false)"></div>
    
        <div class="modal-container">
            <div class="modal-center">
                <div class="modal-panel">
                    
                    <div class="modal-header">
                        <div>
                            <h3 class="modal-title">Tạo Hóa đơn mới</h3>
                            <p style="font-size: 0.875rem; color: #6b7280; margin-top: 2px;">Chọn phòng áp dụng</p>
                        </div>
                        <button type="button" class="btn-icon" onclick="toggleModal(false)">
                            <span class="material-symbols-outlined">close</span>
                        </button>
                    </div>
    
                    <div style="padding: 1rem 1.5rem 0;">
                         <div style="position: relative;">
                             <span class="material-symbols-outlined" style="position: absolute; left: 10px; top: 12px; color: #9ca3af;">apartment</span>
                             <select id="contractSelect" class="form-input" style="padding-left: 2.5rem; background-color: white;">
                                <option value="">Đang tải danh sách phòng...</option>
                            </select>
                             <span class="material-symbols-outlined" style="position: absolute; right: 10px; top: 12px; color: #9ca3af; pointer-events: none;">expand_more</span>
                        </div>
                    </div>
    
                    <div style="padding: 1rem 1.5rem;">
                        <div class="tab-group">
                            <button id="tab-monthly" onclick="switchTab('monthly')" class="tab-btn active">
                                <span class="material-symbols-outlined">calendar_month</span> Hóa đơn hàng tháng
                            </button>
                            <button id="tab-incidental" onclick="switchTab('incidental')" class="tab-btn inactive">
                                <span class="material-symbols-outlined">receipt_long</span> Hóa đơn phát sinh
                            </button>
                        </div>
                    </div>
    
                    <div class="modal-body custom-scrollbar">
                        
                        <div id="form-monthly">
                            <div style="margin-bottom: 1.5rem;">
                                <div class="flex items-center gap-2" style="color: var(--primary-color); margin-bottom: 0.75rem;">
                                    <span class="material-symbols-outlined">info</span>
                                    <h4 class="font-bold text-sm uppercase">Thông tin chung</h4>
                                </div>
                                <div class="flex gap-4">
                                    <div class="w-full">
                                        <label class="form-label">Hóa đơn kỳ (Tháng/Năm)</label>
                                        <input type="month" id="monthlyPeriod" class="form-input">
                                    </div>
                                    <div class="w-full">
                                        <label class="form-label">Hạn thanh toán</label>
                                        <input type="date" id="monthlyDueDate" class="form-input">
                                    </div>
                                </div>
                            </div>
    
                            <div>
                                <div class="flex justify-between items-center" style="margin-bottom: 0.75rem;">
                                    <div class="flex items-center gap-2" style="color: var(--primary-color);">
                                        <span class="material-symbols-outlined">attach_money</span>
                                        <h4 class="font-bold text-sm uppercase">Chi tiết các khoản phí</h4>
                                    </div>
                                    <span class="badge" style="background: #f3f4f6; color: #6b7280; font-weight: normal;">Tự động tính toán</span>
                                </div>
    
                                <div class="flex flex-col gap-3" id="services-container">
                                    <div class="fee-box flex items-center justify-between">
                                        <div class="flex items-center gap-3">
                                            <div class="stat-icon-box" style="background: #e0e7ff; color: #4f46e5;">
                                                <span class="material-symbols-outlined">bed</span>
                                            </div>
                                            <div>
                                                <p class="font-bold text-sm">Tiền phòng</p>
                                                <p style="font-size: 0.75rem; color: #6b7280;">Giá thuê cố định theo hợp đồng</p>
                                            </div>
                                        </div>
                                        <div style="width: 35%; position: relative;">
                                            <input type="text" id="roomPrice" oninput="calculateTotal()" value="0" class="form-input text-right font-bold" style="background: #f9fafb;" readonly>
                                            <span style="position: absolute; right: 8px; top: 9px; font-size: 0.75rem; font-weight: bold; color: #6b7280;">VND</span>
                                        </div>
                                    </div>
                                    <!-- Các dịch vụ sẽ được load động vào đây -->
                                </div>
                            </div>
                            
                            <div class="flex gap-4" style="margin-top: 1.5rem;">
                                <div class="w-full">
                                    <label class="form-label">Ghi chú thêm</label>
                                    <textarea id="monthlyNote" rows="2" class="form-input" placeholder="Nhập ghi chú cho khách thuê..."></textarea>
                                </div>
                            </div>
                        </div>
    
                        <div id="form-incidental" class="hidden">
                            <div class="form-group">
                                 <label class="form-label">Tên dịch vụ / Khoản thu</label>
                                 <input type="text" id="incidentalName" class="form-input" placeholder="VD: Sửa chữa điều hòa, Tiền rác phát sinh...">
                            </div>
    
                            <div class="flex gap-4 form-group">
                                <div class="w-full">
                                    <label class="form-label">Hạn thanh toán</label>
                                    <input type="date" id="incidentalDueDate" class="form-input">
                                </div>
                                <div class="w-full">
                                    <label class="form-label">Đơn giá (VND)</label>
                                    <input type="number" id="incidentalPrice" oninput="calcIncidental()" class="form-input" placeholder="0">
                                </div>
                            </div>
    
                            <div class="form-group">
                                <label class="form-label">Tổng tiền (VND)</label>
                                <input type="text" id="incidentalTotalDisplay" readonly class="form-input" style="background: #eff6ff; border-color: #bfdbfe; color: var(--primary-color); font-weight: bold; font-size: 1.125rem;">
                            </div>
    
                            <div class="form-group">
                                <label class="form-label">Ghi chú</label>
                                <textarea id="incidentalNote" rows="3" class="form-input" placeholder="Nhập ghi chú chi tiết..."></textarea>
                            </div>
                        </div>
    
                    </div>
    
                    <div class="modal-footer">
                        <div>
                            <p style="font-size: 0.75rem; text-transform: uppercase; font-weight: 700; color: #6b7280;">Tổng cộng hóa đơn</p>
                            <p class="grand-total" id="grandTotal">0 <span style="font-size: 0.875rem; font-weight: 500; color: #9ca3af;">VND</span></p>
                        </div>
                        <div class="flex gap-3">
                            <button type="button" class="btn btn-outline" onclick="toggleModal(false)">Hủy bỏ</button>
                            <button type="button" class="btn btn-primary" onclick="createInvoice()">
                                <span class="material-symbols-outlined">save</span> Lưu Hóa đơn
                            </button>
                        </div>
                    </div>
    
                </div>
            </div>
        </div>
    </div>
    
    <script>
        const API_URL = 'http://localhost:3000/api';
        
        // Biến toàn cục lưu giá dịch vụ hiện tại của phòng đang chọn
        // Biến lưu trữ dịch vụ đã được khai báo ở trên
    
        // --- UTILS ---
        function formatCurrency(number) {
            if (!number && number !== 0) return '0';
            return new Intl.NumberFormat('vi-VN').format(number);
        }
        
        function formatDate(dateString) {
            if(!dateString) return '';
            const d = new Date(dateString);
            return d.toLocaleDateString('vi-VN');
        }
    
        // --- KHỞI TẠO ---
        document.addEventListener('DOMContentLoaded', () => {
            loadStats();
            loadActiveContracts(); 
            loadInvoices();        
            
            // Mặc định tháng hiện tại
            const today = new Date();
            const monthStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}`;
            document.getElementById('monthFilter').value = monthStr;
            document.getElementById('monthlyPeriod').value = monthStr;
        });
    
        // --- LOAD DATA ---
        async function loadStats() {
            try {
                const res = await fetch(`${API_URL}/invoices/stats`);
                if (!res.ok) {
                    throw new Error(`HTTP error! status: ${res.status}`);
                }
                const data = await res.json();
                
                document.getElementById('stat-revenue').innerText = formatCurrency(data.revenue_month) + ' đ';
                document.getElementById('stat-pending').innerText = formatCurrency(data.pending_amount) + ' đ';
                document.getElementById('stat-overdue').innerText = data.overdue_count;
            } catch (e) { 
                console.error("Lỗi load stats:", e);
                // Hiển thị 0 nếu có lỗi
                document.getElementById('stat-revenue').innerText = '0 đ';
                document.getElementById('stat-pending').innerText = '0 đ';
                document.getElementById('stat-overdue').innerText = '0';
            }
        }
    
        async function loadInvoices() {
            const month = document.getElementById('monthFilter').value;
            const status = document.getElementById('statusFilter').value;
            const search = document.getElementById('searchInput').value;
    
            try {
                let url = `${API_URL}/invoices?month=${month}&status=${status}`;
                if (search) url += `&search=${search}`;
    
                const res = await fetch(url);
                const invoices = await res.json();
                const tbody = document.getElementById('invoiceTableBody');
                tbody.innerHTML = ''; 
    
                if(invoices.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8" class="text-center" style="padding: 2rem; color: #6b7280;">Không tìm thấy hóa đơn nào trong tháng này</td></tr>';
                    return;
                }
    
                invoices.forEach(inv => {
                    let badgeHtml = '';
                    if (inv.display_status === 'Paid') {
                        badgeHtml = `<span class="badge badge-success" style="background: #dcfce7; color: #166534; padding: 4px 8px; border-radius: 4px; font-size: 12px;">Đã thanh toán</span>`;
                    } else if (inv.display_status === 'Overdue') {
                        badgeHtml = `<span class="badge badge-danger" style="background: #fee2e2; color: #991b1b; padding: 4px 8px; border-radius: 4px; font-size: 12px;">Quá hạn ${inv.overdue_days} ngày</span>`;
                    } else {
                        badgeHtml = `<span class="badge badge-warning" style="background: #fef9c3; color: #854d0e; padding: 4px 8px; border-radius: 4px; font-size: 12px;">Chờ thanh toán</span>`;
                    }
    
                    const typeLabel = inv.invoice_type === 'Incidental' 
                        ? '<span style="font-size:10px; background:#f3f4f6; padding:2px 6px; border-radius:4px;">Phát sinh</span>' 
                        : '<span style="font-size:10px; background:#eff6ff; color:blue; padding:2px 6px; border-radius:4px;">Hàng tháng</span>';
    
                    const invoiceId = parseInt(inv.invoice_id) || 0;
                    const row = `
                        <tr style="cursor: pointer;" onclick="viewInvoiceDetail(${invoiceId})">
                            <td class="font-bold">P.${inv.room_number}</td>
                            <td>${inv.full_name}</td>
                            <td>${typeLabel}</td>
                            <td class="font-bold text-primary">${formatCurrency(inv.total_amount)} đ</td>
                            <td style="color: #6b7280;">${formatDate(inv.created_at)}</td>
                            <td style="color: #6b7280;">${formatDate(inv.due_date)}</td>
                            <td>${badgeHtml}</td>
                            <td class="text-right" onclick="event.stopPropagation();">
                                 ${inv.display_status !== 'Paid' ? 
                                    `<button class="btn-icon" onclick="markPaid(${invoiceId})" title="Xác nhận thanh toán"><span class="material-symbols-outlined" style="color:green; font-size:18px;">check_circle</span></button>` 
                                    : ''}
                                 ${inv.display_status !== 'Paid' ? 
                                    `<button class="btn-icon delete" onclick="deleteInvoice(${invoiceId})" title="Xóa hóa đơn" style="color:#ef4444;"><span class="material-symbols-outlined" style="font-size:18px;">delete</span></button>`
                                    : ''}
                            </td>
                        </tr>
                    `;
                    tbody.insertAdjacentHTML('beforeend', row);
                });
            } catch (e) { console.error(e); }
        }
    
        async function loadActiveContracts() {
            try {
                const res = await fetch(`${API_URL}/contracts/active`);
                if (!res.ok) {
                    throw new Error(`HTTP error! status: ${res.status}`);
                }
                const contracts = await res.json();
                
                const select = document.getElementById('contractSelect');
                select.innerHTML = '<option value="">-- Chọn phòng áp dụng --</option>';
                
                contracts.forEach(c => {
                    const option = document.createElement('option');
                    option.value = c.contract_id;
                    option.text = `P.${c.room_number} - ${c.full_name}`;
                    select.appendChild(option);
                });
            } catch (e) { 
                console.error("Lỗi load active contracts:", e);
                // Giữ nguyên select với option mặc định
            }
        }
    
        // Biến lưu trữ dịch vụ
        let roomServices = [];
        
        // Hàm render dịch vụ động
        function renderServices(services) {
            const container = document.getElementById('services-container');
            if (!container) return;
            
            // Xóa các dịch vụ cũ (trừ tiền phòng)
            const existingServices = container.querySelectorAll('.fee-box:not(:first-child)');
            existingServices.forEach(el => el.remove());
            
            roomServices = [];
            
            if (!services || services.length === 0) {
                return;
            }
            
            services.forEach(svc => {
                const name = svc.service_name.toLowerCase();
                const type = svc.service_type || '';
                const price = parseFloat(svc.unit_price) || 0;
                
                // Kiểm tra xem có phải dịch vụ có chỉ số không (điện/nước)
                const hasMeter = name.includes('điện') || name.includes('nước');
                
                const serviceId = `service-${name.replace(/\s+/g, '-')}`;
                roomServices.push({
                    id: serviceId,
                    name: svc.service_name,
                    type: type,
                    price: price,
                    hasMeter: hasMeter
                });
                
                let html = '';
                if (hasMeter) {
                    // Dịch vụ có chỉ số (điện/nước)
                    const isElectric = name.includes('điện');
                    const unit = isElectric ? 'kWh' : 'm³';
                    const serviceClass = isElectric ? 'electric' : 'water';
                    
                    html = `
                        <div class="fee-box ${serviceClass}" data-service-id="${serviceId}">
                            <div class="flex justify-between items-center mb-2">
                                <div class="flex items-center gap-3">
                                    <div>
                                        <p class="font-bold text-sm">${svc.service_name}</p>
                                        <p style="font-size: 0.75rem; color: #6b7280;">${formatCurrency(price)} đ/${type === 'Theo tháng' ? 'tháng' : (isElectric ? 'kWh' : 'm³')}</p>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <span class="service-total font-bold" data-service-id="${serviceId}">0</span> <span style="font-size: 0.75rem;">VND</span>
                                </div>
                            </div>
                            <div class="meter-input-group">
                                <div class="meter-col border-r">
                                    <label class="meter-label">CHỈ SỐ CŨ</label>
                                    <input type="number" class="meter-input service-old" data-service-id="${serviceId}" oninput="calculateTotal()" placeholder="0">
                                </div>
                                <div class="meter-col">
                                    <label class="meter-label" style="color: var(--primary-color);">CHỈ SỐ MỚI</label>
                                    <input type="number" class="meter-input service-new" data-service-id="${serviceId}" oninput="calculateTotal()" style="color: var(--primary-color);" placeholder="0">
                                </div>
                                <div class="meter-result">
                                    <span class="meter-label">TIÊU THỤ</span>
                                    <span class="font-bold text-sm"><span class="service-usage" data-service-id="${serviceId}">0</span> ${unit}</span>
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    // Dịch vụ tính theo tháng (không có chỉ số)
                    html = `
                        <div class="fee-box flex items-center justify-between" data-service-id="${serviceId}">
                            <div class="flex items-center gap-3">
                                <div>
                                    <p class="font-bold text-sm">${svc.service_name}</p>
                                    <p style="font-size: 0.75rem; color: #6b7280;">${formatCurrency(price)} đ/tháng</p>
                                </div>
                            </div>
                            <div style="width: 35%; position: relative;">
                                <input type="text" class="form-input text-right font-bold service-monthly-total" data-service-id="${serviceId}" value="${formatCurrency(price)}" readonly style="background: #f9fafb;">
                                <span style="position: absolute; right: 8px; top: 9px; font-size: 0.75rem; font-weight: bold; color: #6b7280;">VND</span>
                            </div>
                        </div>
                    `;
                }
                
                container.insertAdjacentHTML('beforeend', html);
            });
            
            calculateTotal();
        }
        
        // --- LOGIC CHỌN PHÒNG & LẤY GIÁ DỊCH VỤ ĐỘNG ---
        document.getElementById('contractSelect').onchange = async function() {
            const contractId = this.value;
            if (!contractId) return;
    
            try {
                // Gọi API lấy chi tiết hợp đồng (bao gồm dịch vụ)
                const res = await fetch(`${API_URL}/contracts/${contractId}`);
                if (!res.ok) {
                    throw new Error(`HTTP error! status: ${res.status}`);
                }
                const data = await res.json();
    
                // 1. Điền giá thuê phòng (format với dấu chấm phân cách)
                const rentAmount = data.rent_amount || 0;
                document.getElementById('roomPrice').value = formatCurrency(rentAmount).replace(/\./g, '');
    
                // 2. Render tất cả dịch vụ từ phòng
                if (data.services && data.services.length > 0) {
                    renderServices(data.services);
                } else {
                    renderServices([]);
                }
                
                // 3. Tính lại tổng sau khi load dữ liệu
                calculateTotal();
    
            } catch (err) {
                console.error("Lỗi lấy chi tiết hợp đồng:", err);
                alert("Không thể lấy giá dịch vụ của phòng này.");
            }
        };
    
        // --- TÍNH TOÁN TỔNG TIỀN ---
        function calculateTotal() {
            // Lấy giá tiền phòng và parse (loại bỏ dấu chấm và khoảng trắng)
            const roomPriceInput = document.getElementById('roomPrice');
            const roomPriceValue = roomPriceInput ? roomPriceInput.value.toString().replace(/[\.\s]/g, '') : '0';
            const roomPrice = parseFloat(roomPriceValue) || 0;
            
            let totalServices = 0;
            
            // Tính toán từng dịch vụ
            if (roomServices && roomServices.length > 0) {
                roomServices.forEach(svc => {
                    if (svc.hasMeter) {
                        // Dịch vụ có chỉ số (điện/nước)
                        const oldInput = document.querySelector(`.service-old[data-service-id="${svc.id}"]`);
                        const newInput = document.querySelector(`.service-new[data-service-id="${svc.id}"]`);
                        const usageEl = document.querySelector(`.service-usage[data-service-id="${svc.id}"]`);
                        const totalEl = document.querySelector(`.service-total[data-service-id="${svc.id}"]`);
                        
                        if (oldInput && newInput && usageEl && totalEl) {
                            const oldVal = parseFloat(oldInput.value) || 0;
                            const newVal = parseFloat(newInput.value) || 0;
                            let usage = newVal - oldVal;
                            if (usage < 0) usage = 0;
                            
                            const total = usage * svc.price;
                            totalServices += total;
                            
                            usageEl.innerText = usage;
                            totalEl.innerText = formatCurrency(total);
                        }
                    } else {
                        // Dịch vụ tính theo tháng
                        totalServices += svc.price;
                    }
                });
            }
            
            const grandTotal = roomPrice + totalServices;
            const grandTotalEl = document.getElementById('grandTotal');
            if (grandTotalEl) {
                grandTotalEl.innerHTML = `${formatCurrency(grandTotal)} <span style="font-size: 0.875rem; font-weight: 500; color: #9ca3af;">VND</span>`;
            }
        }
    
        function calcIncidental() {
            const price = parseFloat(document.getElementById('incidentalPrice').value) || 0;
            document.getElementById('incidentalTotalDisplay').value = formatCurrency(price);
            document.getElementById('grandTotal').innerHTML = `${formatCurrency(price)} <span style="font-size: 0.875rem; font-weight: 500; color: #9ca3af;">VND</span>`;
        }
    
        // --- GỬI FORM ---
        async function createInvoice() {
            const contractId = document.getElementById('contractSelect').value;
            if (!contractId) return alert("Vui lòng chọn phòng!");
    
            const isMonthly = document.getElementById('tab-monthly').classList.contains('active');
            let payload = {};
    
            if (isMonthly) {
                const period = document.getElementById('monthlyPeriod').value;
                const dueDate = document.getElementById('monthlyDueDate').value;
                if(!dueDate) return alert("Vui lòng chọn hạn thanh toán");
    
                const roomPrice = parseFloat(document.getElementById('roomPrice').value.replace(/\./g, '')) || 0;
                
                // Thu thập tất cả dịch vụ
                const items = [];
                let totalServices = 0;
                
                roomServices.forEach(svc => {
                    if (svc.hasMeter) {
                        // Dịch vụ có chỉ số (điện/nước)
                        const oldInput = document.querySelector(`.service-old[data-service-id="${svc.id}"]`);
                        const newInput = document.querySelector(`.service-new[data-service-id="${svc.id}"]`);
                        const totalEl = document.querySelector(`.service-total[data-service-id="${svc.id}"]`);
                        
                        if (oldInput && newInput && totalEl) {
                            const oldVal = oldInput.value || null;
                            const newVal = newInput.value || null;
                            const amount = parseFloat(totalEl.innerText.replace(/\./g, '')) || 0;
                            totalServices += amount;
                            
                            items.push({
                                name: svc.name,
                                old: oldVal,
                                new: newVal,
                                amount: amount,
                                price: svc.price
                            });
                        }
                    } else {
                        // Dịch vụ tính theo tháng
                        totalServices += svc.price;
                        items.push({
                            name: svc.name,
                            old: null,
                            new: null,
                            amount: svc.price,
                            price: svc.price
                        });
                    }
                });
                
                const total = roomPrice + totalServices;
    
                payload = {
                    type: 'Monthly',
                    contract_id: contractId,
                    billing_period: period,
                    due_date: dueDate,
                    room_rent: roomPrice,
                    total_amount: total,
                    items: items,
                    notes: document.getElementById('monthlyNote').value
                };
            } else {
                const dueDate = document.getElementById('incidentalDueDate').value;
                if(!dueDate) return alert("Vui lòng chọn hạn thanh toán");
                const amount = parseFloat(document.getElementById('incidentalPrice').value) || 0;
                const name = document.getElementById('incidentalName').value;
                if(!name) return alert("Vui lòng nhập tên khoản thu");
    
                payload = {
                    type: 'Incidental',
                    contract_id: contractId,
                    due_date: dueDate,
                    total_amount: amount,
                    items: [{ name: name, amount: amount }],
                    notes: document.getElementById('incidentalNote').value
                };
            }
    
            try {
                const res = await fetch(`${API_URL}/invoices`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });
                
                if (res.ok) {
                    alert('Tạo hóa đơn thành công!');
                    toggleModal(false);
                    loadStats();
                    loadInvoices();
                } else {
                    const err = await res.json();
                    alert('Lỗi: ' + (err.message || 'Không thể tạo hóa đơn'));
                }
            } catch (e) { console.error(e); }
        }
    
        async function markPaid(id) {
            if(!confirm('Xác nhận khách đã thanh toán hóa đơn này?')) return;
            try {
                const res = await fetch(`${API_URL}/invoices/${id}/status`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ status: 'Paid' })
                });
                if(res.ok) {
                    loadStats();
                    loadInvoices();
                }
            } catch(e) { console.error(e); }
        }
    
        async function deleteInvoice(id) {
            // Kiểm tra trạng thái hóa đơn trước khi xóa
            try {
                const invoiceRes = await fetch(`${API_URL}/invoices/${id}`);
                if (!invoiceRes.ok) {
                    throw new Error('Không thể lấy thông tin hóa đơn');
                }
                const invoice = await invoiceRes.json();
                
                // Kiểm tra nếu hóa đơn đã thanh toán
                if (invoice.status === 'Paid' || invoice.display_status === 'Paid') {
                    alert('Không thể xóa hóa đơn đã thanh toán.');
                    return;
                }
                
                // Xác nhận xóa
                if (!confirm('Bạn có chắc chắn muốn xóa hóa đơn này? Hành động này không thể hoàn tác.')) {
                    return;
                }
                
                // Gửi yêu cầu xóa
                const res = await fetch(`${API_URL}/invoices/${id}`, {
                    method: 'DELETE',
                    headers: {'Content-Type': 'application/json'}
                });
                
                if (!res.ok) {
                    const error = await res.json().catch(() => ({ message: 'Lỗi không xác định' }));
                    throw new Error(error.message || 'Lỗi khi xóa hóa đơn');
                }
                
                alert('Đã xóa hóa đơn thành công!');
                
                // Reload dữ liệu
                loadStats();
                loadInvoices();
            } catch(e) { 
                console.error('Lỗi xóa hóa đơn:', e);
                alert('Lỗi: ' + (e.message || 'Không thể xóa hóa đơn'));
            }
        }
    
        // --- HELPER UI ---
        function toggleModal(show) {
            const modal = document.getElementById('invoiceModal');
            if (show) {
                modal.classList.add('open');
                switchTab('monthly');
            } else {
                modal.classList.remove('open');
                // Reset
                document.getElementById('contractSelect').value = "";
                document.getElementById('roomPrice').value = "0";
                roomServices = [];
                // Xóa tất cả dịch vụ động (trừ tiền phòng)
                const container = document.getElementById('services-container');
                if (container) {
                    const existingServices = container.querySelectorAll('.fee-box:not(:first-child)');
                    existingServices.forEach(el => el.remove());
                }
                document.getElementById('grandTotal').innerHTML = "0 <span style=\"font-size: 0.875rem; font-weight: 500; color: #9ca3af;\">VND</span>";
            }
        }
    
        function switchTab(tabName) {
            const btnMonthly = document.getElementById('tab-monthly');
            const btnIncidental = document.getElementById('tab-incidental');
            const formMonthly = document.getElementById('form-monthly');
            const formIncidental = document.getElementById('form-incidental');
    
            if (tabName === 'monthly') {
                btnMonthly.className = "tab-btn active";
                btnIncidental.className = "tab-btn inactive";
                formMonthly.classList.remove('hidden');
                formIncidental.classList.add('hidden');
            } else {
                btnIncidental.className = "tab-btn active";
                btnMonthly.className = "tab-btn inactive";
                formIncidental.classList.remove('hidden');
                formMonthly.classList.add('hidden');
            }
        }
        
        // --- XEM CHI TIẾT HÓA ĐƠN ---
        async function viewInvoiceDetail(invoiceId) {
            // Validate và parse invoiceId
            const id = parseInt(invoiceId);
            if (isNaN(id) || id <= 0) {
                alert('ID hóa đơn không hợp lệ');
                return;
            }
            
            toggleInvoiceDetailModal(true);
            
            const content = document.getElementById('invoice-detail-content');
            content.innerHTML = `
                <div style="text-align: center; padding: 2rem;">
                    <span class="material-symbols-outlined" style="font-size: 48px; color: #9ca3af;">hourglass_empty</span>
                    <p style="color: #6b7280; margin-top: 1rem;">Đang tải thông tin...</p>
                </div>
            `;
            
            try {
                const res = await fetch(`${API_URL}/invoices/${id}`);
                if (!res.ok) {
                    throw new Error(`HTTP error! status: ${res.status}`);
                }
                
                const invoice = await res.json();
                
                // Format ngày
                const createdDate = formatDate(invoice.created_at);
                const dueDate = formatDate(invoice.due_date);
                const paidDate = invoice.paid_date ? formatDate(invoice.paid_date) : null;
                
                // Trạng thái
                let statusBadge = '';
                if (invoice.display_status === 'Paid') {
                    statusBadge = '<span class="badge badge-success" style="background: #dcfce7; color: #166534; padding: 4px 12px; border-radius: 6px; font-size: 12px; font-weight: 600;">Đã thanh toán</span>';
                } else if (invoice.display_status === 'Overdue') {
                    statusBadge = `<span class="badge badge-danger" style="background: #fee2e2; color: #991b1b; padding: 4px 12px; border-radius: 6px; font-size: 12px; font-weight: 600;">Quá hạn ${invoice.overdue_days} ngày</span>`;
                } else {
                    statusBadge = '<span class="badge badge-warning" style="background: #fef9c3; color: #854d0e; padding: 4px 12px; border-radius: 6px; font-size: 12px; font-weight: 600;">Chờ thanh toán</span>';
                }
                
                // Loại hóa đơn
                const typeLabel = invoice.invoice_type === 'Incidental' 
                    ? '<span style="font-size:12px; background:#f3f4f6; padding:4px 8px; border-radius:4px; font-weight: 500;">Phát sinh</span>' 
                    : '<span style="font-size:12px; background:#eff6ff; color:#2563eb; padding:4px 8px; border-radius:4px; font-weight: 500;">Hàng tháng</span>';
                
                // Chi tiết các khoản phí
                let itemsHtml = '';
                if (invoice.items && invoice.items.length > 0) {
                    invoice.items.forEach(item => {
                        const isMeterService = item.previous_reading !== null && item.current_reading !== null;
                        
                        if (isMeterService) {
                            const usage = (parseFloat(item.current_reading) || 0) - (parseFloat(item.previous_reading) || 0);
                            itemsHtml += `
                                <div style="background: #f9fafb; padding: 1rem; border-radius: 8px; margin-bottom: 0.75rem;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                        <div>
                                            <p style="font-weight: 600; font-size: 14px; margin-bottom: 4px;">${item.service_name || 'Dịch vụ'}</p>
                                            <p style="font-size: 12px; color: #6b7280;">${item.service_type || ''}</p>
                                        </div>
                                        <div style="text-align: right;">
                                            <p style="font-weight: 700; font-size: 16px; color: var(--primary-color);">${formatCurrency(item.amount || 0)} đ</p>
                                        </div>
                                    </div>
                                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem; margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid #e5e7eb;">
                                        <div>
                                            <p style="font-size: 11px; color: #6b7280; margin-bottom: 4px;">CHỈ SỐ CŨ</p>
                                            <p style="font-weight: 600;">${item.previous_reading || 0}</p>
                                        </div>
                                        <div>
                                            <p style="font-size: 11px; color: var(--primary-color); margin-bottom: 4px;">CHỈ SỐ MỚI</p>
                                            <p style="font-weight: 600; color: var(--primary-color);">${item.current_reading || 0}</p>
                                        </div>
                                        <div>
                                            <p style="font-size: 11px; color: #6b7280; margin-bottom: 4px;">TIÊU THỤ</p>
                                            <p style="font-weight: 600;">${usage} ${item.service_name && item.service_name.toLowerCase().includes('điện') ? 'kWh' : 'm³'}</p>
                                        </div>
                                    </div>
                                    <div style="margin-top: 0.5rem; font-size: 12px; color: #6b7280;">
                                        Đơn giá: ${formatCurrency(item.unit_price || 0)} đ
                                    </div>
                                </div>
                            `;
                        } else {
                            itemsHtml += `
                                <div style="background: #f9fafb; padding: 1rem; border-radius: 8px; margin-bottom: 0.75rem;">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <div>
                                            <p style="font-weight: 600; font-size: 14px; margin-bottom: 4px;">${item.service_name || 'Dịch vụ'}</p>
                                            <p style="font-size: 12px; color: #6b7280;">${item.service_type || 'Theo tháng'}</p>
                                        </div>
                                        <div style="text-align: right;">
                                            <p style="font-weight: 700; font-size: 16px; color: var(--primary-color);">${formatCurrency(item.amount || 0)} đ</p>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }
                    });
                } else {
                    // Nếu không có items, hiển thị tiền phòng
                    itemsHtml = `
                        <div style="background: #f9fafb; padding: 1rem; border-radius: 8px;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <p style="font-weight: 600; font-size: 14px;">Tiền phòng</p>
                                    <p style="font-size: 12px; color: #6b7280;">Giá thuê cố định theo hợp đồng</p>
                                </div>
                                <div style="text-align: right;">
                                    <p style="font-weight: 700; font-size: 16px; color: var(--primary-color);">${formatCurrency(invoice.room_rent || 0)} đ</p>
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                content.innerHTML = `
                    <div style="padding: 0 0.5rem;">
                        <!-- Thông tin chung -->
                        <div style="margin-bottom: 1.5rem;">
                            <div class="flex items-center gap-2" style="color: var(--primary-color); margin-bottom: 0.75rem;">
                                <span class="material-symbols-outlined">info</span>
                                <h4 class="font-bold text-sm uppercase">Thông tin chung</h4>
                            </div>
                            <div style="background: #f9fafb; padding: 1rem; border-radius: 8px;">
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                    <div>
                                        <p style="font-size: 12px; color: #6b7280; margin-bottom: 4px;">Phòng</p>
                                        <p style="font-weight: 600;">P.${invoice.room_number} - ${invoice.house_name || ''}</p>
                                    </div>
                                    <div>
                                        <p style="font-size: 12px; color: #6b7280; margin-bottom: 4px;">Người thuê</p>
                                        <p style="font-weight: 600;">${invoice.full_name}</p>
                                    </div>
                                    <div>
                                        <p style="font-size: 12px; color: #6b7280; margin-bottom: 4px;">Loại hóa đơn</p>
                                        <p>${typeLabel}</p>
                                    </div>
                                    <div>
                                        <p style="font-size: 12px; color: #6b7280; margin-bottom: 4px;">Trạng thái</p>
                                        <p>${statusBadge}</p>
                                    </div>
                                    <div>
                                        <p style="font-size: 12px; color: #6b7280; margin-bottom: 4px;">Ngày tạo</p>
                                        <p style="font-weight: 600;">${createdDate}</p>
                                    </div>
                                    <div>
                                        <p style="font-size: 12px; color: #6b7280; margin-bottom: 4px;">Hạn thanh toán</p>
                                        <p style="font-weight: 600;">${dueDate}</p>
                                    </div>
                                    ${paidDate ? `
                                    <div>
                                        <p style="font-size: 12px; color: #6b7280; margin-bottom: 4px;">Ngày thanh toán</p>
                                        <p style="font-weight: 600; color: #16a34a;">${paidDate}</p>
                                    </div>
                                    ` : ''}
                                    ${invoice.billing_period ? `
                                    <div>
                                        <p style="font-size: 12px; color: #6b7280; margin-bottom: 4px;">Kỳ hóa đơn</p>
                                        <p style="font-weight: 600;">${invoice.billing_period}</p>
                                    </div>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                        
                        <!-- Chi tiết các khoản phí -->
                        <div style="margin-bottom: 1.5rem;">
                            <div class="flex items-center gap-2" style="color: var(--primary-color); margin-bottom: 0.75rem;">
                                <span class="material-symbols-outlined">attach_money</span>
                                <h4 class="font-bold text-sm uppercase">Chi tiết các khoản phí</h4>
                            </div>
                            ${itemsHtml}
                        </div>
                        
                        <!-- Tổng cộng -->
                        <div style="background: #eff6ff; padding: 1rem; border-radius: 8px; border: 2px solid #bfdbfe;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <p style="font-weight: 700; font-size: 14px; text-transform: uppercase; color: #1e40af;">Tổng cộng hóa đơn</p>
                                <p style="font-weight: 700; font-size: 20px; color: var(--primary-color);">${formatCurrency(invoice.total_amount || 0)} đ</p>
                            </div>
                        </div>
                        
                        ${invoice.notes ? `
                        <div style="margin-top: 1.5rem;">
                            <p style="font-size: 12px; color: #6b7280; margin-bottom: 0.5rem; font-weight: 600;">Ghi chú</p>
                            <div style="background: #f9fafb; padding: 1rem; border-radius: 8px; border-left: 3px solid var(--primary-color);">
                                <p style="font-size: 14px; color: #374151; white-space: pre-wrap;">${invoice.notes}</p>
                            </div>
                        </div>
                        ` : ''}
                    </div>
                `;
                
                document.getElementById('detail-invoice-number').textContent = `Hóa đơn #${invoice.invoice_id}`;
                
            } catch (err) {
                console.error('View Invoice Detail Error:', err);
                content.innerHTML = `
                    <div style="text-align: center; padding: 2rem;">
                        <span class="material-symbols-outlined" style="font-size: 48px; color: #ef4444;">error</span>
                        <p style="color: #6b7280; margin-top: 1rem;">Không thể tải thông tin hóa đơn</p>
                        <p style="color: #9ca3af; font-size: 12px; margin-top: 0.5rem;">${err.message}</p>
                    </div>
                `;
            }
        }
        
        function toggleInvoiceDetailModal(show) {
            const modal = document.getElementById('invoiceDetailModal');
            if (show) {
                modal.classList.add('open');
            } else {
                modal.classList.remove('open');
            }
        }
    </script>
    
    <!-- Modal Chi tiết Hóa đơn -->
    <div id="invoiceDetailModal" class="modal" role="dialog" aria-modal="true">
        <div class="modal-backdrop" onclick="toggleInvoiceDetailModal(false)"></div>
    
        <div class="modal-container">
            <div class="modal-center">
                <div class="modal-panel" style="max-width: 800px;">
                    
                    <div class="modal-header">
                        <div>
                            <h3 class="modal-title">Chi tiết Hóa đơn</h3>
                            <p style="font-size: 0.875rem; color: #6b7280; margin-top: 2px;" id="detail-invoice-number"></p>
                        </div>
                        <button type="button" class="btn-icon" onclick="toggleInvoiceDetailModal(false)">
                            <span class="material-symbols-outlined">close</span>
                        </button>
                    </div>
    
                    <div class="modal-body custom-scrollbar" id="invoice-detail-content">
                        <div style="text-align: center; padding: 2rem;">
                            <span class="material-symbols-outlined" style="font-size: 48px; color: #9ca3af;">hourglass_empty</span>
                            <p style="color: #6b7280; margin-top: 1rem;">Đang tải thông tin...</p>
                        </div>
                    </div>
    
                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline" onclick="toggleInvoiceDetailModal(false)">Đóng</button>
                    </div>
    
                </div>
            </div>
        </div>
    </div>
    
    </body>
</html>
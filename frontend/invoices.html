<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Quản lý thanh toán - Hệ thống quản lý nhà trọ</title>
    
    <link href="https://fonts.googleapis.com" rel="preconnect"/>
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;700;800&amp;family=Noto+Sans:wght@400;500;700&amp;display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap" rel="stylesheet"/>

    <link rel="stylesheet" href="css/invoice.css">
</head>
<body>

    <div class="app-container">
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="logo-box">
                    <span class="material-symbols-outlined">home</span>
                </div>
                <div>
                    <h1 class="font-bold text-xl">TroViet</h1>
                    <p style="font-size: 10px; color: #bfdbfe; text-transform: uppercase;">Cổng Chủ nhà</p>
                </div>
            </div>
    
            <div class="sidebar-user">
                <div class="flex items-center gap-3">
                    <div class="user-avatar text-white">
                        <span class="material-symbols-outlined" style="font-size: 18px;">person</span>
                    </div>
                    <div style="overflow: hidden;">
                        <p class="font-bold text-sm truncate">Admin</p>
                        <p class="truncate" style="font-size: 10px; color: #bfdbfe;">admin@troviet.com</p>
                    </div>
                </div>
                <button class="btn-icon" style="color: #bfdbfe;">
                    <span class="material-symbols-outlined">notifications</span>
                </button>
            </div>
    
            <nav class="nav-list">
                <a class="nav-item" href="dashboard.html">
                    <span class="material-symbols-outlined">bar_chart</span> Tổng quan
                </a>
                <a class="nav-item" href="property.html">
                    <span class="material-symbols-outlined">real_estate_agent</span> Bất động sản
                </a>
                <a class="nav-item" href="contract.html">
                    <span class="material-symbols-outlined">group</span> Người thuê
                </a>
                <a class="nav-item active" href="invoice.html">
                    <span class="material-symbols-outlined icon-filled">attach_money</span> Hóa đơn
                </a>
                <a class="nav-item" href="#">
                    <span class="material-symbols-outlined">build</span> Bảo trì
                </a>
            </nav>
    
            <div class="sidebar-footer">
                <a class="nav-item" href="#">
                    <span class="material-symbols-outlined">settings</span> Cài đặt
                </a>
                <a class="nav-item" href="#">
                    <span class="material-symbols-outlined">logout</span> Đăng xuất
                </a>
            </div>
        </aside>
    
        <main class="main-content">
            <div class="content-scroll">
                <div class="page-container">
                    
                    <div class="flex justify-between items-center" style="flex-wrap: wrap; gap: 1rem;">
                        <div>
                            <h1 class="font-bold" style="font-size: 1.875rem;">Tổng quan hóa đơn</h1>
                            <p style="color: var(--text-gray); font-size: 0.875rem; margin-top: 4px;">Theo dõi dòng tiền và trạng thái thanh toán theo thời gian thực</p>
                        </div>
                        <div>
                            <button onclick="toggleModal(true)" class="btn btn-primary">
                                <span class="material-symbols-outlined">add</span> Tạo hóa đơn mới
                            </button>
                        </div>
                    </div>
    
                    <div class="stat-grid">
                        <div class="card card-flex">
                            <div>
                                <p class="text-gray-500 font-medium" style="font-size: 0.875rem; margin-bottom: 4px;">Tổng thu nhập tháng này</p>
                                <h3 class="font-bold" style="font-size: 1.5rem;" id="stat-revenue">0 đ</h3>
                                <div class="flex items-center gap-2" style="margin-top: 1rem; font-size: 0.75rem; color: var(--success); font-weight: 500;">
                                    <span class="material-symbols-outlined" style="font-size: 16px;">trending_up</span> Thực thu (Đã thanh toán)
                                </div>
                            </div>
                            <div class="stat-icon-box bg-green-50">
                                <span class="material-symbols-outlined">attach_money</span>
                            </div>
                        </div>
                        <div class="card card-flex">
                            <div>
                                <p class="text-gray-500 font-medium" style="font-size: 0.875rem; margin-bottom: 4px;">Chờ thanh toán</p>
                                <h3 class="font-bold" style="font-size: 1.5rem;" id="stat-pending">0 đ</h3>
                                <div class="flex items-center gap-2" style="margin-top: 1rem; font-size: 0.75rem; color: var(--text-gray); font-weight: 500;">
                                    Chưa quá hạn
                                </div>
                            </div>
                            <div class="stat-icon-box bg-yellow-50">
                                <span class="material-symbols-outlined">hourglass_top</span>
                            </div>
                        </div>
                        <div class="card card-flex">
                            <div>
                                <p class="text-gray-500 font-medium" style="font-size: 0.875rem; margin-bottom: 4px;">Hóa đơn quá hạn</p>
                                <h3 class="font-bold" style="font-size: 1.5rem;" id="stat-overdue">0</h3>
                                <div class="flex items-center gap-2" style="margin-top: 1rem; font-size: 0.75rem; color: var(--danger); font-weight: 500; cursor: pointer;">
                                    Cần xử lý ngay
                                </div>
                            </div>
                            <div class="stat-icon-box bg-red-50">
                                <span class="material-symbols-outlined">warning</span>
                            </div>
                        </div>
                    </div>
    
                    <div class="filter-bar">
                        <div class="search-wrapper">
                            <span class="material-symbols-outlined search-icon">search</span>
                            <input type="text" id="searchInput" class="search-input" placeholder="Tìm tên khách hoặc số phòng..." onkeyup="loadInvoices()">
                        </div>
                        <div class="flex gap-3">
                            <input type="month" id="monthFilter" class="select-input" style="width: auto;" onchange="loadInvoices()">
                            
                            <select id="statusFilter" class="select-input" onchange="loadInvoices()">
                                <option value="all">Tất cả trạng thái</option>
                                <option value="paid">Đã thanh toán</option>
                                <option value="pending">Chưa thanh toán</option>
                                <option value="overdue">Quá hạn</option>
                            </select>
                        </div>
                    </div>
    
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Phòng</th>
                                    <th>Người thuê</th>
                                    <th>Loại</th>
                                    <th>Số tiền</th>
                                    <th>Ngày tạo</th>
                                    <th>Hạn đóng</th>
                                    <th>Trạng thái</th>
                                    <th class="text-right">Hành động</th>
                                </tr>
                            </thead>
                            <tbody id="invoiceTableBody">
                                <tr><td colspan="8" class="text-center" style="padding: 20px;">Đang tải dữ liệu...</td></tr>
                            </tbody>
                        </table>
                    </div>
    
                    <div style="height: 40px;"></div>
                </div>
            </div>
        </main>
    </div>
    
    <div id="invoiceModal" class="modal" role="dialog" aria-modal="true">
        <div class="modal-backdrop" onclick="toggleModal(false)"></div>
    
        <div class="modal-container">
            <div class="modal-center">
                <div class="modal-panel">
                    
                    <div class="modal-header">
                        <div>
                            <h3 class="modal-title">Tạo Hóa đơn mới</h3>
                            <p style="font-size: 0.875rem; color: #6b7280; margin-top: 2px;">Chọn phòng áp dụng</p>
                        </div>
                        <button type="button" class="btn-icon" onclick="toggleModal(false)">
                            <span class="material-symbols-outlined">close</span>
                        </button>
                    </div>
    
                    <div style="padding: 1rem 1.5rem 0;">
                         <div style="position: relative;">
                             <span class="material-symbols-outlined" style="position: absolute; left: 10px; top: 12px; color: #9ca3af;">apartment</span>
                             <select id="contractSelect" class="form-input" style="padding-left: 2.5rem; background-color: white;">
                                <option value="">Đang tải danh sách phòng...</option>
                            </select>
                             <span class="material-symbols-outlined" style="position: absolute; right: 10px; top: 12px; color: #9ca3af; pointer-events: none;">expand_more</span>
                        </div>
                    </div>
    
                    <div style="padding: 1rem 1.5rem;">
                        <div class="tab-group">
                            <button id="tab-monthly" onclick="switchTab('monthly')" class="tab-btn active">
                                <span class="material-symbols-outlined">calendar_month</span> Hóa đơn hàng tháng
                            </button>
                            <button id="tab-incidental" onclick="switchTab('incidental')" class="tab-btn inactive">
                                <span class="material-symbols-outlined">receipt_long</span> Hóa đơn phát sinh
                            </button>
                        </div>
                    </div>
    
                    <div class="modal-body custom-scrollbar">
                        
                        <div id="form-monthly">
                            <div style="margin-bottom: 1.5rem;">
                                <div class="flex items-center gap-2" style="color: var(--primary-color); margin-bottom: 0.75rem;">
                                    <span class="material-symbols-outlined">info</span>
                                    <h4 class="font-bold text-sm uppercase">Thông tin chung</h4>
                                </div>
                                <div class="flex gap-4">
                                    <div class="w-full">
                                        <label class="form-label">Hóa đơn kỳ (Tháng/Năm)</label>
                                        <input type="month" id="monthlyPeriod" class="form-input">
                                    </div>
                                    <div class="w-full">
                                        <label class="form-label">Hạn thanh toán</label>
                                        <input type="date" id="monthlyDueDate" class="form-input">
                                    </div>
                                </div>
                            </div>
    
                            <div>
                                <div class="flex justify-between items-center" style="margin-bottom: 0.75rem;">
                                    <div class="flex items-center gap-2" style="color: var(--primary-color);">
                                        <span class="material-symbols-outlined">attach_money</span>
                                        <h4 class="font-bold text-sm uppercase">Chi tiết các khoản phí</h4>
                                    </div>
                                    <span class="badge" style="background: #f3f4f6; color: #6b7280; font-weight: normal;">Tự động tính toán</span>
                                </div>
    
                                <div class="flex flex-col gap-3">
                                    <div class="fee-box flex items-center justify-between">
                                        <div class="flex items-center gap-3">
                                            <div class="stat-icon-box" style="background: #e0e7ff; color: #4f46e5;">
                                                <span class="material-symbols-outlined">bed</span>
                                            </div>
                                            <div>
                                                <p class="font-bold text-sm">Tiền phòng</p>
                                                <p style="font-size: 0.75rem; color: #6b7280;">Giá thuê cố định theo hợp đồng</p>
                                            </div>
                                        </div>
                                        <div style="width: 35%; position: relative;">
                                            <input type="text" id="roomPrice" oninput="calculateTotal()" value="0" class="form-input text-right font-bold" style="background: #f9fafb;" readonly>
                                            <span style="position: absolute; right: 8px; top: 9px; font-size: 0.75rem; font-weight: bold; color: #6b7280;">VND</span>
                                        </div>
                                    </div>
    
                                    <div class="fee-box electric">
                                        <div class="flex justify-between items-center mb-2">
                                            <div class="flex items-center gap-3">
                                                <div class="stat-icon-box" style="background: #fef9c3; color: #ca8a04; width: 32px; height: 32px;">
                                                    <span class="material-symbols-outlined">bolt</span>
                                                </div>
                                                <div>
                                                    <p class="font-bold text-sm">Tiền điện</p>
                                                    <p style="font-size: 0.75rem; color: #6b7280;">Chưa cập nhật giá</p>
                                                </div>
                                            </div>
                                            <div class="text-right">
                                                <span id="elecTotal" class="font-bold">0</span> <span style="font-size: 0.75rem;">VND</span>
                                            </div>
                                        </div>
                                        <div class="meter-input-group">
                                            <div class="meter-col border-r">
                                                <label class="meter-label">CHỈ SỐ CŨ</label>
                                                <input type="number" id="elecOld" oninput="calculateTotal()" class="meter-input" placeholder="0">
                                            </div>
                                            <div class="meter-col">
                                                <label class="meter-label" style="color: var(--primary-color);">CHỈ SỐ MỚI</label>
                                                <input type="number" id="elecNew" oninput="calculateTotal()" class="meter-input" style="color: var(--primary-color);" placeholder="0">
                                            </div>
                                            <div class="meter-result">
                                                <span class="meter-label">TIÊU THỤ</span>
                                                <span class="font-bold text-sm"><span id="elecUsage">0</span> kWh</span>
                                            </div>
                                        </div>
                                    </div>
    
                                    <div class="fee-box water">
                                        <div class="flex justify-between items-center mb-2">
                                            <div class="flex items-center gap-3">
                                                <div class="stat-icon-box" style="background: #dbeafe; color: #2563eb; width: 32px; height: 32px;">
                                                    <span class="material-symbols-outlined">water_drop</span>
                                                </div>
                                                <div>
                                                    <p class="font-bold text-sm">Tiền nước</p>
                                                    <p style="font-size: 0.75rem; color: #6b7280;">Chưa cập nhật giá</p>
                                                </div>
                                            </div>
                                            <div class="text-right">
                                                <span id="waterTotal" class="font-bold">0</span> <span style="font-size: 0.75rem;">VND</span>
                                            </div>
                                        </div>
                                        <div class="meter-input-group">
                                            <div class="meter-col border-r">
                                                <label class="meter-label">CHỈ SỐ CŨ</label>
                                                <input type="number" id="waterOld" oninput="calculateTotal()" class="meter-input" placeholder="0">
                                            </div>
                                            <div class="meter-col">
                                                <label class="meter-label" style="color: var(--primary-color);">CHỈ SỐ MỚI</label>
                                                <input type="number" id="waterNew" oninput="calculateTotal()" class="meter-input" style="color: var(--primary-color);" placeholder="0">
                                            </div>
                                            <div class="meter-result">
                                                <span class="meter-label">TIÊU THỤ</span>
                                                <span class="font-bold text-sm"><span id="waterUsage">0</span> m³</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="flex gap-4" style="margin-top: 1.5rem;">
                                <div class="w-full">
                                    <label class="form-label">Ghi chú thêm</label>
                                    <textarea id="monthlyNote" rows="2" class="form-input" placeholder="Nhập ghi chú cho khách thuê..."></textarea>
                                </div>
                            </div>
                        </div>
    
                        <div id="form-incidental" class="hidden">
                            <div class="form-group">
                                 <label class="form-label">Tên dịch vụ / Khoản thu</label>
                                 <input type="text" id="incidentalName" class="form-input" placeholder="VD: Sửa chữa điều hòa, Tiền rác phát sinh...">
                            </div>
    
                            <div class="flex gap-4 form-group">
                                <div class="w-full">
                                    <label class="form-label">Hạn thanh toán</label>
                                    <input type="date" id="incidentalDueDate" class="form-input">
                                </div>
                                <div class="w-full">
                                    <label class="form-label">Đơn giá (VND)</label>
                                    <input type="number" id="incidentalPrice" oninput="calcIncidental()" class="form-input" placeholder="0">
                                </div>
                            </div>
    
                            <div class="form-group">
                                <label class="form-label">Tổng tiền (VND)</label>
                                <input type="text" id="incidentalTotalDisplay" readonly class="form-input" style="background: #eff6ff; border-color: #bfdbfe; color: var(--primary-color); font-weight: bold; font-size: 1.125rem;">
                            </div>
    
                            <div class="form-group">
                                <label class="form-label">Ghi chú</label>
                                <textarea id="incidentalNote" rows="3" class="form-input" placeholder="Nhập ghi chú chi tiết..."></textarea>
                            </div>
                        </div>
    
                    </div>
    
                    <div class="modal-footer">
                        <div>
                            <p style="font-size: 0.75rem; text-transform: uppercase; font-weight: 700; color: #6b7280;">Tổng cộng hóa đơn</p>
                            <p class="grand-total" id="grandTotal">0 <span style="font-size: 0.875rem; font-weight: 500; color: #9ca3af;">VND</span></p>
                        </div>
                        <div class="flex gap-3">
                            <button type="button" class="btn btn-outline" onclick="toggleModal(false)">Hủy bỏ</button>
                            <button type="button" class="btn btn-primary" onclick="createInvoice()">
                                <span class="material-symbols-outlined">save</span> Lưu Hóa đơn
                            </button>
                        </div>
                    </div>
    
                </div>
            </div>
        </div>
    </div>
    
    <script>
        const API_URL = 'http://localhost:3000/api';
        
        // Biến toàn cục lưu giá dịch vụ hiện tại của phòng đang chọn
        let currentElecPrice = 0;
        let currentWaterPrice = 0;
    
        // --- UTILS ---
        function formatCurrency(number) {
            if (!number && number !== 0) return '0';
            return new Intl.NumberFormat('vi-VN').format(number);
        }
        
        function formatDate(dateString) {
            if(!dateString) return '';
            const d = new Date(dateString);
            return d.toLocaleDateString('vi-VN');
        }
    
        // --- KHỞI TẠO ---
        document.addEventListener('DOMContentLoaded', () => {
            loadStats();
            loadActiveContracts(); 
            loadInvoices();        
            
            // Mặc định tháng hiện tại
            const today = new Date();
            const monthStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}`;
            document.getElementById('monthFilter').value = monthStr;
            document.getElementById('monthlyPeriod').value = monthStr;
        });
    
        // --- LOAD DATA ---
        async function loadStats() {
            try {
                const res = await fetch(`${API_URL}/invoice-stats`);
                const data = await res.json();
                
                document.getElementById('stat-revenue').innerText = formatCurrency(data.revenue_month) + ' đ';
                document.getElementById('stat-pending').innerText = formatCurrency(data.pending_amount) + ' đ';
                document.getElementById('stat-overdue').innerText = data.overdue_count;
            } catch (e) { console.error("Lỗi load stats:", e); }
        }
    
        async function loadInvoices() {
            const month = document.getElementById('monthFilter').value;
            const status = document.getElementById('statusFilter').value;
            const search = document.getElementById('searchInput').value;
    
            try {
                let url = `${API_URL}/invoices?month=${month}&status=${status}`;
                if (search) url += `&search=${search}`;
    
                const res = await fetch(url);
                const invoices = await res.json();
                const tbody = document.getElementById('invoiceTableBody');
                tbody.innerHTML = ''; 
    
                if(invoices.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8" class="text-center" style="padding: 2rem; color: #6b7280;">Không tìm thấy hóa đơn nào trong tháng này</td></tr>';
                    return;
                }
    
                invoices.forEach(inv => {
                    let badgeHtml = '';
                    if (inv.display_status === 'Paid') {
                        badgeHtml = `<span class="badge badge-success" style="background: #dcfce7; color: #166534; padding: 4px 8px; border-radius: 4px; font-size: 12px;">Đã thanh toán</span>`;
                    } else if (inv.display_status === 'Overdue') {
                        badgeHtml = `<span class="badge badge-danger" style="background: #fee2e2; color: #991b1b; padding: 4px 8px; border-radius: 4px; font-size: 12px;">Quá hạn ${inv.overdue_days} ngày</span>`;
                    } else {
                        badgeHtml = `<span class="badge badge-warning" style="background: #fef9c3; color: #854d0e; padding: 4px 8px; border-radius: 4px; font-size: 12px;">Chờ thanh toán</span>`;
                    }
    
                    const typeLabel = inv.invoice_type === 'Incidental' 
                        ? '<span style="font-size:10px; background:#f3f4f6; padding:2px 6px; border-radius:4px;">Phát sinh</span>' 
                        : '<span style="font-size:10px; background:#eff6ff; color:blue; padding:2px 6px; border-radius:4px;">Hàng tháng</span>';
    
                    const row = `
                        <tr>
                            <td class="font-bold">P.${inv.room_number}</td>
                            <td>${inv.full_name}</td>
                            <td>${typeLabel}</td>
                            <td class="font-bold text-primary">${formatCurrency(inv.total_amount)} đ</td>
                            <td style="color: #6b7280;">${formatDate(inv.created_at)}</td>
                            <td style="color: #6b7280;">${formatDate(inv.due_date)}</td>
                            <td>${badgeHtml}</td>
                            <td class="text-right">
                                 ${inv.display_status !== 'Paid' ? 
                                    `<button class="btn-icon" onclick="markPaid(${inv.invoice_id})" title="Xác nhận thanh toán"><span class="material-symbols-outlined" style="color:green; font-size:18px;">check_circle</span></button>` 
                                    : ''}
                                 <button class="btn-icon delete" style="color:#ef4444;"><span class="material-symbols-outlined" style="font-size:18px;">delete</span></button>
                            </td>
                        </tr>
                    `;
                    tbody.insertAdjacentHTML('beforeend', row);
                });
            } catch (e) { console.error(e); }
        }
    
        async function loadActiveContracts() {
            try {
                const res = await fetch(`${API_URL}/contracts-active`);
                const contracts = await res.json();
                
                const select = document.getElementById('contractSelect');
                select.innerHTML = '<option value="">-- Chọn phòng áp dụng --</option>';
                
                contracts.forEach(c => {
                    const option = document.createElement('option');
                    option.value = c.contract_id;
                    option.text = `P.${c.room_number} - ${c.full_name}`;
                    select.appendChild(option);
                });
            } catch (e) { console.error(e); }
        }
    
        // --- LOGIC CHỌN PHÒNG & LẤY GIÁ DỊCH VỤ ĐỘNG ---
        document.getElementById('contractSelect').onchange = async function() {
            const contractId = this.value;
            if (!contractId) return;
    
            try {
                // Gọi API lấy chi tiết giá của phòng này
                const res = await fetch(`${API_URL}/contract-details/${contractId}`);
                const data = await res.json();
    
                // 1. Điền giá thuê phòng
                document.getElementById('roomPrice').value = formatCurrency(data.rent_amount).replace(/\./g, '');
    
                // 2. Tìm giá Điện & Nước trong danh sách dịch vụ trả về
                currentElecPrice = 0;
                currentWaterPrice = 0;
                
                let elecLabel = "Chưa thiết lập giá";
                let waterLabel = "Chưa thiết lập giá";
    
                if (data.services && data.services.length > 0) {
                    data.services.forEach(svc => {
                        const name = svc.service_name.toLowerCase();
                        const type = svc.service_type;
    
                        if (name.includes('điện')) {
                            currentElecPrice = parseFloat(svc.unit_price);
                            elecLabel = `${formatCurrency(currentElecPrice)} đ/${type === 'Theo tháng' ? 'tháng' : 'kWh'}`;
                        }
                        if (name.includes('nước')) {
                            currentWaterPrice = parseFloat(svc.unit_price);
                            waterLabel = `${formatCurrency(currentWaterPrice)} đ/${type === 'Theo người' ? 'người' : (type === 'Theo tháng' ? 'tháng' : 'm³')}`;
                        }
                    });
                }
    
                // Cập nhật giao diện Label giá
                const elecBox = document.querySelector('.fee-box.electric');
                if(elecBox) elecBox.querySelector('p:nth-child(2)').innerText = elecLabel;
                
                const waterBox = document.querySelector('.fee-box.water');
                if(waterBox) waterBox.querySelector('p:nth-child(2)').innerText = waterLabel;
    
                // Tính toán lại tổng ngay lập tức
                calculateTotal();
    
            } catch (err) {
                console.error("Lỗi lấy chi tiết hợp đồng:", err);
                alert("Không thể lấy giá dịch vụ của phòng này.");
            }
        };
    
        // --- TÍNH TOÁN TỔNG TIỀN ---
        function calculateTotal() {
            const roomPrice = parseFloat(document.getElementById('roomPrice').value.replace(/\./g, '')) || 0;
            
            // ĐIỆN
            const elecOld = parseFloat(document.getElementById('elecOld').value) || 0;
            const elecNew = parseFloat(document.getElementById('elecNew').value) || 0;
            let elecUsage = elecNew - elecOld;
            if (elecUsage < 0) elecUsage = 0;
            const elecTotal = elecUsage * currentElecPrice; 
    
            // NƯỚC
            const waterOld = parseFloat(document.getElementById('waterOld').value) || 0;
            const waterNew = parseFloat(document.getElementById('waterNew').value) || 0;
            let waterUsage = waterNew - waterOld;
            if (waterUsage < 0) waterUsage = 0;
            const waterTotal = waterUsage * currentWaterPrice;
    
            // Cập nhật UI
            document.getElementById('elecUsage').innerText = elecUsage;
            document.getElementById('elecTotal').innerText = formatCurrency(elecTotal);
            
            document.getElementById('waterUsage').innerText = waterUsage;
            document.getElementById('waterTotal').innerText = formatCurrency(waterTotal);
    
            const grandTotal = roomPrice + elecTotal + waterTotal;
            document.getElementById('grandTotal').innerHTML = `${formatCurrency(grandTotal)} <span style="font-size: 0.875rem; font-weight: 500; color: #9ca3af;">VND</span>`;
        }
    
        function calcIncidental() {
            const price = parseFloat(document.getElementById('incidentalPrice').value) || 0;
            document.getElementById('incidentalTotalDisplay').value = formatCurrency(price);
            document.getElementById('grandTotal').innerHTML = `${formatCurrency(price)} <span style="font-size: 0.875rem; font-weight: 500; color: #9ca3af;">VND</span>`;
        }
    
        // --- GỬI FORM ---
        async function createInvoice() {
            const contractId = document.getElementById('contractSelect').value;
            if (!contractId) return alert("Vui lòng chọn phòng!");
    
            const isMonthly = document.getElementById('tab-monthly').classList.contains('active');
            let payload = {};
    
            if (isMonthly) {
                const period = document.getElementById('monthlyPeriod').value;
                const dueDate = document.getElementById('monthlyDueDate').value;
                if(!dueDate) return alert("Vui lòng chọn hạn thanh toán");
    
                const roomPrice = parseFloat(document.getElementById('roomPrice').value.replace(/\./g, '')) || 0;
                const elecTotal = parseFloat(document.getElementById('elecTotal').innerText.replace(/\./g, '')) || 0;
                const waterTotal = parseFloat(document.getElementById('waterTotal').innerText.replace(/\./g, '')) || 0;
                const total = roomPrice + elecTotal + waterTotal;
    
                payload = {
                    type: 'Monthly',
                    contract_id: contractId,
                    billing_period: period,
                    due_date: dueDate,
                    room_rent: roomPrice,
                    total_amount: total,
                    items: [
                        { 
                            name: 'Tiền điện', 
                            old: document.getElementById('elecOld').value, 
                            new: document.getElementById('elecNew').value, 
                            amount: elecTotal, 
                            price: currentElecPrice 
                        },
                        { 
                            name: 'Tiền nước', 
                            old: document.getElementById('waterOld').value, 
                            new: document.getElementById('waterNew').value, 
                            amount: waterTotal, 
                            price: currentWaterPrice
                        }
                    ],
                    notes: document.getElementById('monthlyNote').value
                };
            } else {
                const dueDate = document.getElementById('incidentalDueDate').value;
                if(!dueDate) return alert("Vui lòng chọn hạn thanh toán");
                const amount = parseFloat(document.getElementById('incidentalPrice').value) || 0;
                const name = document.getElementById('incidentalName').value;
                if(!name) return alert("Vui lòng nhập tên khoản thu");
    
                payload = {
                    type: 'Incidental',
                    contract_id: contractId,
                    due_date: dueDate,
                    total_amount: amount,
                    items: [{ name: name, amount: amount }],
                    notes: document.getElementById('incidentalNote').value
                };
            }
    
            try {
                const res = await fetch(`${API_URL}/invoices`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });
                
                if (res.ok) {
                    alert('Tạo hóa đơn thành công!');
                    toggleModal(false);
                    loadStats();
                    loadInvoices();
                } else {
                    const err = await res.json();
                    alert('Lỗi: ' + (err.message || 'Không thể tạo hóa đơn'));
                }
            } catch (e) { console.error(e); }
        }
    
        async function markPaid(id) {
            if(!confirm('Xác nhận khách đã thanh toán hóa đơn này?')) return;
            try {
                const res = await fetch(`${API_URL}/invoices/${id}/status`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ status: 'Paid' })
                });
                if(res.ok) {
                    loadStats();
                    loadInvoices();
                }
            } catch(e) { console.error(e); }
        }
    
        // --- HELPER UI ---
        function toggleModal(show) {
            const modal = document.getElementById('invoiceModal');
            if (show) {
                modal.classList.add('open');
                switchTab('monthly');
            } else {
                modal.classList.remove('open');
                // Reset
                document.getElementById('contractSelect').value = "";
                document.getElementById('roomPrice').value = "0";
                document.getElementById('elecOld').value = ""; document.getElementById('elecNew').value = "";
                document.getElementById('waterOld').value = ""; document.getElementById('waterNew').value = "";
                document.getElementById('grandTotal').innerText = "0 VND";
            }
        }
    
        function switchTab(tabName) {
            const btnMonthly = document.getElementById('tab-monthly');
            const btnIncidental = document.getElementById('tab-incidental');
            const formMonthly = document.getElementById('form-monthly');
            const formIncidental = document.getElementById('form-incidental');
    
            if (tabName === 'monthly') {
                btnMonthly.className = "tab-btn active";
                btnIncidental.className = "tab-btn inactive";
                formMonthly.classList.remove('hidden');
                formIncidental.classList.add('hidden');
            } else {
                btnIncidental.className = "tab-btn active";
                btnMonthly.className = "tab-btn inactive";
                formIncidental.classList.remove('hidden');
                formMonthly.classList.add('hidden');
            }
        }
    </script>
    
    </body>
</html>